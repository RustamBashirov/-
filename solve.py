import numpy as np


def receiverXYZ2sat(M):
    """
    Функция определения координат приемника и поправок псевдодальностей
    по данным 6 спутников (2 группы по 3 спутника)
    
    Параметры:
    M : numpy.ndarray
        Входная матрица размером (6, 5) с данными спутников:
        - Столбец 0: dT_sys - системные временные поправки
        - Столбец 1: psd - псевдодальности
        - Столбец 2: X_gr - координата X спутника в геоцентрической системе
        - Столбец 3: Y_gr - координата Y спутника в геоцентрической системе
        - Столбец 4: Z_gr - координата Z спутника в геоцентрической системе
    
    Возвращает:
    list : [x_p, y_p, z_p, d_DP1, d_DP2, d_DP3]
        - x_p, y_p, z_p - координаты приемника
        - d_DP1, d_DP2, d_DP3 - поправки псевдодальностей
    """
    # Константы
    csv = 299792458  # Скорость света, м/с
    wz = 7.2921151467e-5  # Угловая скорость вращения Земли, рад/с

    # Инициализация переменных
    x_p, y_p, z_p = 0.0, 0.0, 0.0  # Начальные координаты приемника
    d_DP1, d_DP2, d_DP3 = 0.0, 0.0, 0.0  # Поправки псевдодальностей
    PR = 0  # Флаг завершения расчетов
    iterator = 0  # Счетчик итераций

    # Извлечение данных из матрицы
    dT_sys = M[:, 0]  # Системные временные поправки
    psd = M[:, 1] * csv  # Псевдодальности переведенные в метры
    X_gr = M[:, 2]  # X-координаты спутников
    Y_gr = M[:, 3]  # Y-координаты спутников
    Z_gr = M[:, 4]  # Z-координаты спутников

    # Основной итерационный цикл
    while True:
        # Инициализация массивов для текущей итерации
        D_p = np.zeros(6)  # Расстояния от приемника до спутников
        ksi = np.zeros(6)  # Вектор невязок
        Hs = np.zeros((6, 6))  # Матрица наблюдений

        # Расчет расстояний и формирование матрицы наблюдений
        for i in range(2):  # Обработка двух групп спутников
            # Группа 1: спутники 0, 1, 2
            D_p[i] = np.sqrt((x_p - X_gr[i])**2 + 
                            (y_p - Y_gr[i])**2 + 
                            (z_p - Z_gr[i])**2)
            # Группа 2: спутники 2, 3, 4
            D_p[i+2] = np.sqrt((x_p - X_gr[i+2])**2 + 
                              (y_p - Y_gr[i+2])**2 + 
                              (z_p - Z_gr[i+2])**2)
            # Группа 3: спутники 4, 5 (i=0,1)
            D_p[i+4] = np.sqrt((x_p - X_gr[i+4])**2 + 
                              (y_p - Y_gr[i+4])**2 + 
                              (z_p - Z_gr[i+4])**2)

            # Расчет невязок для разных групп спутников
            ksi[i] = psd[i] - csv*dT_sys[i] - D_p[i] - d_DP1
            ksi[i+2] = psd[i+2] - csv*dT_sys[i+2] - D_p[i+2] - d_DP2
            ksi[i+4] = psd[i+4] - csv*dT_sys[i+4] - D_p[i+4] - d_DP3

            # Заполнение матрицы наблюдений для группы 1
            Hs[i, 0] = (x_p - X_gr[i]) / D_p[i]  # Производная по X
            Hs[i, 1] = (y_p - Y_gr[i]) / D_p[i]  # Производная по Y
            Hs[i, 2] = (z_p - Z_gr[i]) / D_p[i]  # Производная по Z
            Hs[i, 3] = 1  # Производная по d_DP1
            Hs[i, 4] = 0
            Hs[i, 5] = 0

            # Заполнение матрицы наблюдений для группы 2
            Hs[i+2, 0] = (x_p - X_gr[i+2]) / D_p[i+2]
            Hs[i+2, 1] = (y_p - Y_gr[i+2]) / D_p[i+2]
            Hs[i+2, 2] = (z_p - Z_gr[i+2]) / D_p[i+2]
            Hs[i+2, 3] = 0
            Hs[i+2, 4] = 1  # Производная по d_DP2
            Hs[i+2, 5] = 0

            # Заполнение матрицы наблюдений для группы 3
            Hs[i+4, 0] = (x_p - X_gr[i+4]) / D_p[i+4]
            Hs[i+4, 1] = (y_p - Y_gr[i+4]) / D_p[i+4]
            Hs[i+4, 2] = (z_p - Z_gr[i+4]) / D_p[i+4]
            Hs[i+4, 3] = 0
            Hs[i+4, 4] = 0
            Hs[i+4, 5] = 1  # Производная по d_DP3

        # Решение системы методом наименьших квадратов
        Hst = Hs.T  # Транспонирование матрицы
        A = np.linalg.inv(Hst @ Hs)  # Вычисление обратной матрицы
        Q = A @ Hst @ ksi  # Вектор поправок

        # Применение поправок
        x_p += Q[0]
        y_p += Q[1]
        z_p += Q[2]
        d_DP1 += Q[3]
        d_DP2 += Q[4]
        d_DP3 += Q[5]

        iterator += 1

        # Проверка условия завершения
        if PR == 1:
            # Формирование результата и запись в файл
            out = [x_p, y_p, z_p, d_DP1, d_DP2, d_DP3]
            
            with open('answer.txt', 'w') as file:
                file.write(f"x_p = {out[0]:.5f} y_p = {out[1]:.5f} z_p = {out[2]:.5f}\n")
                file.write(f"d_dp1 = {out[3]:.10f} d_dp2 = {out[4]:.10f} d_dp3 = {out[5]:.10f}\n")
            
            return out

        # Проверка условий сходимости
        if (all(abs(Q) < 1)):
            # Учет вращения Земли при сходимости
            R = np.zeros(6)  # Обновленные расстояния
            Tau = np.zeros(6)  # Времена распространения сигнала
            Alfa = np.zeros(6)  # Углы поворота Земли

            for i in range(2):
                # Расчет новых расстояний
                R[i] = np.sqrt((x_p - X_gr[i])**2 + 
                              (y_p - Y_gr[i])**2 + 
                              (z_p - Z_gr[i])**2)
                R[i+2] = np.sqrt((x_p - X_gr[i+2])**2 + 
                                (y_p - Y_gr[i+2])**2 + 
                                (z_p - Z_gr[i+2])**2)
                R[i+4] = np.sqrt((x_p - X_gr[i+4])**2 + 
                                (y_p - Y_gr[i+4])**2 + 
                                (z_p - Z_gr[i+4])**2)

                # Расчет времен распространения
                Tau[i] = R[i] / csv
                Tau[i+2] = R[i+2] / csv
                Tau[i+4] = R[i+4] / csv

                # Расчет углов поворота Земли
                Alfa[i] = Tau[i] * wz
                Alfa[i+2] = Tau[i+2] * wz
                Alfa[i+4] = Tau[i+4] * wz

                # Коррекция координат спутников due to Earth rotation
                X_gr[i] += Y_gr[i] * Alfa[i]
                X_gr[i+2] += Y_gr[i+2] * Alfa[i+2]
                X_gr[i+4] += Y_gr[i+4] * Alfa[i+4]

                Y_gr[i] -= X_gr[i] * Alfa[i]
                Y_gr[i+2] -= X_gr[i+2] * Alfa[i+2]
                Y_gr[i+4] -= X_gr[i+4] * Alfa[i+4]

            PR = 1  # Установка флага завершения

# Создание тестовых данных (6 спутников)
M = np.array([
    [0.001, 21000000, 15000000, 20000000, 25000000],
    [0.001, 22000000, 16000000, 21000000, 26000000],
    [0.001, 23000000, 17000000, 22000000, 27000000],
    [0.001, 24000000, 18000000, 23000000, 28000000],
    [0.001, 25000000, 19000000, 24000000, 29000000],
    [0.001, 26000000, 20000000, 25000000, 30000000]
])

result = receiverXYZ2sat(M)
print(result)